{% extends "base.html" %}
{% block title %}Expedientes{% endblock %}
{% block heading %}Expedientes <span class="badge-count">{{ total }}</span>{% endblock %}

{% block header_actions %}
<a href="/expediente/nuevo" class="btn btn-primary">‚ûï Nuevo Expediente</a>
<a href="/exportar" class="btn btn-outline">üì§ Exportar Excel</a>
{% endblock %}

{% block content %}

<!-- FILTROS -->
<form method="get" action="/" class="filtros-card">
    <div class="filtros-grid">
        <div class="field-group">
            <label>Buscar</label>
            <input type="text" name="q" value="{{ q }}" placeholder="N¬∞ expediente, investigado, asunto‚Ä¶">
        </div>
        <div class="field-group">
            <label>A√±o</label>
            <select name="anio">
                <option value="">Todos</option>
                {% for a in anios %}
                <option value="{{ a }}" {% if anio_filtro == a|string %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="field-group">
            <label>Etapa</label>
            <select name="etapa">
                <option value="">Todas</option>
                {% for e in etapas %}
                <option value="{{ e }}" {% if etapa_filtro == e %}selected{% endif %}>{{ e }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="field-group">
            <label>Abogado</label>
            <select name="abogado">
                <option value="">Todos</option>
                {% for ab in abogados %}
                <option value="{{ ab }}" {% if abogado_filtro == ab %}selected{% endif %}>{{ ab }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filtros-actions">
            <button type="submit" class="btn btn-primary">üîç Filtrar</button>
            <a href="/" class="btn btn-outline">‚úñ Limpiar</a>
        </div>
    </div>
</form>

<!-- TABLA -->
{% if expedientes %}
<div class="table-wrapper">
    <table class="data-table">
        <thead>
            <tr>
                <th>N¬∞ Exp.</th>
                <th>A√±o</th>
                <th>Investigado</th>
                <th>Abogado</th>
                <th>Etapa</th>
                <th>Estado</th>
                <th>Vencimiento Ind.</th>
                <th>Vencimiento Inv.</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for exp in expedientes %}
            <tr>
                <td class="exp-num"><strong>{{ exp.n_expediente }}</strong></td>
                <td>{{ exp.anio }}</td>
                <td class="td-texto">{{ exp.investigado or '‚Äî' }}</td>
                <td class="td-texto">{{ exp.nombre_abogado or '‚Äî' }}</td>
                <td>
                    {% if exp.etapa %}
                    <span class="etapa-badge etapa-{{ exp.etapa | lower | replace(' ','_') | replace('√°','a') | replace('√©','e') | replace('√≥','o') | replace('√∫','u') | replace('√±','n') | truncate(15, True, '') }}">
                        {{ exp.etapa }}
                    </span>
                    {% else %}‚Äî{% endif %}
                </td>
                <td>{{ exp.estado_proceso or '‚Äî' }}</td>
                <td>
                    {% if exp.fecha_vencimiento_ind %}
                    <span class="alerta-badge alerta-{{ exp.alerta_ind.clase }}">
                        {{ exp.fecha_vencimiento_ind }}<br>
                        <small>{{ exp.alerta_ind.texto }}</small>
                    </span>
                    {% else %}‚Äî{% endif %}
                </td>
                <td>
                    {% if exp.fecha_vencimiento_inv %}
                    <span class="alerta-badge alerta-{{ exp.alerta_inv.clase }}">
                        {{ exp.fecha_vencimiento_inv }}<br>
                        <small>{{ exp.alerta_inv.texto }}</small>
                    </span>
                    {% else %}‚Äî{% endif %}
                </td>
                <td class="td-acciones">
                    <a href="/expediente/{{ exp.id }}" class="btn-sm btn-ver">üëÅ Ver</a>
                    <a href="/expediente/{{ exp.id }}/editar" class="btn-sm btn-editar">‚úèÔ∏è Editar</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">
    <div class="empty-icon">üìÇ</div>
    <h3>No hay expedientes</h3>
    {% if q or anio_filtro or etapa_filtro or abogado_filtro %}
    <p>No se encontraron resultados con los filtros aplicados.</p>
    <a href="/" class="btn btn-outline">Ver todos</a>
    {% else %}
    <p>A√∫n no hay expedientes registrados.</p>
    <a href="/expediente/nuevo" class="btn btn-primary">‚ûï Crear el primero</a>
    <span class="separator"> o </span>
    <a href="/importar" class="btn btn-outline">üì• Importar desde Excel</a>
    {% endif %}
</div>
{% endif %}

{% endblock %}
