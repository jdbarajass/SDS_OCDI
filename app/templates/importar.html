{% extends "base.html" %}
{% block title %}Importar Excel{% endblock %}
{% block heading %}Importar desde Excel{% endblock %}

{% block content %}

<!-- Mensaje de base de datos limpiada -->
{% if msg == 'bd_limpiada' %}
<div class="alert alert-success">
    ‚úÖ Base de datos eliminada correctamente. Ya puede importar el Excel actualizado.
</div>
{% endif %}

<div class="import-layout">

    <!-- Panel de instrucciones -->
    <div class="import-info card">
        <h3>üìã Instrucciones</h3>
        <ol>
            <li>Seleccione el archivo Excel (<code>.xlsx</code>) con los expedientes.</li>
            <li>El sistema buscar√° la hoja <strong>ENCABEZADO</strong>. Si no existe, usar√° la primera hoja.</li>
            <li>La primera fila del archivo se toma como encabezado y se omite.</li>
            <li>Los expedientes con el mismo <strong>N¬∞ Expediente + A√±o</strong> ya existentes <em>se omiten</em> para no duplicar datos.</li>
            <li>Puede repetir la importaci√≥n con el mismo archivo sin problemas.</li>
        </ol>

        <div class="info-box">
            <strong>‚ö†Ô∏è Nota:</strong> Las columnas de "Alertas de vencimiento" (calculadas en Excel) no se importan.
            El sistema las calcula autom√°ticamente.
        </div>

        <div class="info-box info-box-tip" style="margin-top:10px; border-left-color:#e67e22; background:#fff8f0">
            <strong>üí° ¬øActualiz√≥ el Excel?</strong> Si el Excel ya fue modificado y quiere que la BD refleje
            esos cambios, primero <strong>borre la base de datos</strong> y luego importe el Excel nuevo.
            El sistema no actualiza registros ya existentes, solo agrega los que no existen.
        </div>
    </div>

    <!-- Formulario de carga -->
    <div class="import-form card">
        <h3>üì• Seleccionar Archivo</h3>
        <form method="post" action="/importar" enctype="multipart/form-data" id="form-importar">
            <div class="upload-zone" id="upload-zone">
                <div class="upload-icon">üìÑ</div>
                <p>Arrastre el archivo aqu√≠ o haga clic para seleccionar</p>
                <input type="file" id="archivo" name="archivo" accept=".xlsx,.xls"
                       onchange="mostrarNombreArchivo(this)" required>
                <span class="upload-filename" id="upload-filename"></span>
            </div>
            <button type="submit" class="btn btn-primary btn-lg" id="btn-importar">
                üì• Importar
            </button>
        </form>
    </div>

    <!-- Resultado de la importaci√≥n -->
    {% if resultado %}
    <div class="import-result card">
        <h3>üìä Resultado de la Importaci√≥n</h3>
        <div class="result-stats">
            <div class="stat-card stat-success">
                <span class="stat-num">{{ resultado.insertados }}</span>
                <span class="stat-label">Expedientes importados</span>
            </div>
            <div class="stat-card stat-warning">
                <span class="stat-num">{{ resultado.omitidos }}</span>
                <span class="stat-label">Omitidos (ya existen)</span>
            </div>
            <div class="stat-card stat-info">
                <span class="stat-label">Hoja usada</span>
                <span class="stat-num-sm">{{ resultado.hoja_usada }}</span>
            </div>
        </div>

        {% if resultado.errores %}
        <div class="result-errors">
            <h4>‚ö†Ô∏è Filas con error ({{ resultado.errores | length }})</h4>
            <ul class="error-list">
                {% for err in resultado.errores %}
                <li>{{ err }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if resultado.insertados > 0 %}
        <div class="result-actions">
            <a href="/" class="btn btn-primary">üìã Ver Expedientes</a>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Panel de borrado total -->
    <div class="card" style="border: 2px solid #e74c3c; margin-top: 8px;">
        <h3 style="color:#c0392b">üóëÔ∏è Zona de Peligro ‚Äî Borrar Base de Datos</h3>
        <div style="display:flex; align-items:center; gap:24px; flex-wrap:wrap">
            <div style="flex:1; min-width:220px">
                <p style="margin:0 0 6px 0; color:#555">
                    Elimina <strong>todos</strong> los expedientes, escaneos y actuaciones registradas.
                    Esta acci√≥n <strong>no se puede deshacer</strong>.
                </p>
                <p style="margin:0; font-size:13px; color:#888">
                    Expedientes actuales en la base de datos:
                    <strong style="color:#c0392b; font-size:16px"> {{ total_bd }}</strong>
                </p>
            </div>
            <button type="button" class="btn btn-danger" onclick="confirmarBorrado()">
                üóëÔ∏è Borrar toda la base de datos
            </button>
        </div>
    </div>

</div>

<!-- MODAL de confirmaci√≥n -->
<div id="modal-borrado" class="modal-overlay" style="display:none">
    <div class="modal-box" style="max-width:440px; border-top: 4px solid #e74c3c">
        <div class="modal-header">
            <h3 style="color:#c0392b">‚ö†Ô∏è Confirmar borrado total</h3>
        </div>
        <div style="padding: 16px 0">
            <p>Est√° a punto de eliminar <strong>todos los expedientes</strong> de la base de datos.</p>
            <p>Esta acci√≥n es <strong>irreversible</strong>. Aseg√∫rese de tener el Excel actualizado antes de continuar.</p>
            <p style="margin-top:16px; font-size:13px; color:#888">
                Para confirmar, escriba <strong>BORRAR</strong> en el campo de abajo:
            </p>
            <input type="text" id="input-confirmar" placeholder="Escriba BORRAR"
                   style="width:100%; padding:8px; font-size:15px; border:2px solid #e74c3c;
                          border-radius:6px; margin-top:6px; box-sizing:border-box"
                   oninput="validarConfirmacion()">
        </div>
        <div class="modal-actions">
            <form method="post" action="/importar/limpiar-bd" id="form-borrado">
                <button type="submit" id="btn-confirmar-borrado" class="btn btn-danger" disabled>
                    üóëÔ∏è S√≠, borrar todo
                </button>
            </form>
            <button type="button" class="btn btn-outline" onclick="cerrarModalBorrado()">
                Cancelar
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function mostrarNombreArchivo(input) {
    const span = document.getElementById('upload-filename');
    if (input.files.length > 0) {
        span.textContent = '‚úÖ ' + input.files[0].name;
        document.getElementById('upload-zone').classList.add('has-file');
    }
}

document.getElementById('form-importar').addEventListener('submit', function() {
    const btn = document.getElementById('btn-importar');
    btn.textContent = '‚è≥ Importando...';
    btn.disabled = true;
});

function confirmarBorrado() {
    document.getElementById('input-confirmar').value = '';
    document.getElementById('btn-confirmar-borrado').disabled = true;
    document.getElementById('modal-borrado').style.display = 'flex';
    document.getElementById('input-confirmar').focus();
}

function cerrarModalBorrado() {
    document.getElementById('modal-borrado').style.display = 'none';
}

function validarConfirmacion() {
    const val = document.getElementById('input-confirmar').value.trim().toUpperCase();
    document.getElementById('btn-confirmar-borrado').disabled = (val !== 'BORRAR');
}

document.getElementById('modal-borrado').addEventListener('click', function(e) {
    if (e.target === this) cerrarModalBorrado();
});
</script>
{% endblock %}
