{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block heading %}Dashboard{% endblock %}

{% block header_actions %}
<a href="/expediente/nuevo" class="btn btn-primary">‚ûï Nuevo Expediente</a>
{% endblock %}

{% block content %}

<!-- MODAL EXPORTAR -->
<div id="modal-export" class="modal-overlay" style="display:none" onclick="if(event.target===this)cerrarModal()">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="modal-titulo">Exportar expedientes</h3>
      <button class="modal-close" onclick="cerrarModal()">&times;</button>
    </div>
    <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px" id="modal-desc"></p>
    <div class="modal-actions">
      <a id="btn-solo"  href="#" class="btn btn-primary">üì• Solo los filtrados</a>
      <a id="btn-todos" href="#" class="btn btn-outline">üìä Todo + indicador de filtro</a>
      <a id="btn-ver"   href="#" class="btn btn-outline">üîç Ver en lista</a>
    </div>
    <p style="font-size:11px;color:var(--text-muted);margin-top:12px">
      <strong>Solo filtrados:</strong> descarga √∫nicamente los expedientes del filtro.<br>
      <strong>Todo + indicador:</strong> descarga todos con columna EN&nbsp;FILTRO (SI/NO); use AutoFiltro de Excel para ver solo los del filtro o quitarlo para ver todo.
    </p>
  </div>
</div>

<!-- ‚îÄ‚îÄ TARJETAS RESUMEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="dash-cards">
    <div class="dash-card dash-card-blue">
        <div class="dash-card-num">{{ total }}</div>
        <div class="dash-card-label">Total Expedientes</div>
        <a href="/" class="dash-card-link">Ver todos ‚Üí</a>
    </div>
    <div class="dash-card dash-card-danger">
        <div class="dash-card-num">{{ vencidos }}</div>
        <div class="dash-card-label">Vencidos</div>
        <a href="#" onclick="abrirModal('vencidos',{{ vencidos }},'solo_vencidos=1');return false" class="dash-card-link">Exportar ‚Üí</a>
    </div>
    <div class="dash-card dash-card-warning">
        <div class="dash-card-num">{{ prox30 }}</div>
        <div class="dash-card-label">Vencen en 30 d√≠as</div>
        <a href="#" onclick="abrirModal('prox30',{{ prox30 }},'proximos_30=1');return false" class="dash-card-link">Exportar ‚Üí</a>
    </div>
    <div class="dash-card dash-card-info">
        <div class="dash-card-num">{{ prox60 }}</div>
        <div class="dash-card-label">Vencen en 31‚Äì60 d√≠as</div>
        <a href="#" onclick="abrirModal('prox60',{{ prox60 }},'proximos_60=1');return false" class="dash-card-link">Exportar ‚Üí</a>
    </div>
</div>

<!-- ‚îÄ‚îÄ FILA DE ESTAD√çSTICAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="dash-stats-row">

    <!-- Por etapa -->
    <div class="dash-stat-card card">
        <h3 class="stat-card-title">Expedientes por Etapa</h3>
        {% for item in por_etapa %}
        <div class="bar-item">
            <span class="bar-label" title="{{ item.etapa }}">{{ item.etapa | truncate(30) }}</span>
            <div class="bar-track">
                <div class="bar-fill bar-blue" style="width: {{ (item.cantidad / total * 100) | int }}%"></div>
            </div>
            <span class="bar-count">{{ item.cantidad }}</span>
        </div>
        {% endfor %}
    </div>

    <!-- Por estado -->
    <div class="dash-stat-card card">
        <h3 class="stat-card-title">Expedientes por Estado</h3>
        {% for item in por_estado %}
        <div class="bar-item">
            <span class="bar-label" title="{{ item.estado }}">{{ item.estado | truncate(28) }}</span>
            <div class="bar-track">
                <div class="bar-fill bar-green" style="width: {{ (item.cantidad / total * 100) | int }}%"></div>
            </div>
            <span class="bar-count">{{ item.cantidad }}</span>
        </div>
        {% endfor %}
    </div>

    <!-- Por a√±o -->
    <div class="dash-stat-card card">
        <h3 class="stat-card-title">Expedientes por A√±o</h3>
        {% for item in por_anio %}
        <div class="bar-item">
            <span class="bar-label">{{ item.anio }}</span>
            <div class="bar-track">
                <div class="bar-fill bar-purple" style="width: {{ (item.cantidad / total * 100) | int }}%"></div>
            </div>
            <span class="bar-count">{{ item.cantidad }}</span>
        </div>
        {% endfor %}
    </div>

</div>

<!-- ‚îÄ‚îÄ ORIGEN Y TIPOLOG√çA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="dash-stats-row" style="margin-bottom:16px">

    <!-- Por origen -->
    <div class="dash-stat-card card">
        <h3 class="stat-card-title">Por Origen del Proceso</h3>
        {% if por_origen %}
        {% set max_origen = por_origen[0].cantidad %}
        {% for item in por_origen %}
        <div class="bar-item">
            <span class="bar-label" title="{{ item.origen }}">{{ item.origen | truncate(28) }}</span>
            <div class="bar-track">
                <div class="bar-fill bar-orange" style="width: {{ (item.cantidad / max_origen * 100) | int }}%"></div>
            </div>
            <span class="bar-count">{{ item.cantidad }}</span>
        </div>
        {% endfor %}
        {% else %}
        <p style="color:var(--text-muted);font-size:12px">Sin datos de origen registrados</p>
        {% endif %}
    </div>

    <!-- Por tipolog√≠a -->
    <div class="dash-stat-card card">
        <h3 class="stat-card-title">Top Tipolog√≠as</h3>
        {% if por_tipologia %}
        {% set max_tip = por_tipologia[0].cantidad %}
        {% for item in por_tipologia %}
        <div class="bar-item">
            <span class="bar-label" title="{{ item.tipologia }}">{{ item.tipologia | truncate(28) }}</span>
            <div class="bar-track">
                <div class="bar-fill bar-teal" style="width: {{ (item.cantidad / max_tip * 100) | int }}%"></div>
            </div>
            <span class="bar-count">{{ item.cantidad }}</span>
        </div>
        {% endfor %}
        {% else %}
        <p style="color:var(--text-muted);font-size:12px">Sin datos de tipolog√≠a registrados</p>
        {% endif %}
    </div>

</div>

<!-- ‚îÄ‚îÄ TENDENCIA MENSUAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
{% if tendencia %}
<div class="card" style="margin-bottom:16px">
    <h3 class="stat-card-title">Tendencia Mensual de Ingreso</h3>
    <div class="tendencia-chart">
        {% for t in tendencia %}
        <div class="tend-col">
            <div class="tend-bar-wrap">
                <div class="tend-bar" style="height: {{ (t.cantidad / tendencia_max * 100) | int }}%"
                     title="{{ t.etiqueta }}: {{ t.cantidad }}"></div>
            </div>
            <div class="tend-label">{{ t.etiqueta }}</div>
            <div class="tend-num">{{ t.cantidad }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- ‚îÄ‚îÄ POR ABOGADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="dash-abogados card">
    <h3 class="stat-card-title">Carga por Abogado</h3>
    <div class="abogado-grid">
        {% for item in por_abogado %}
        <div class="abogado-card">
            <div class="abogado-name">{{ item.abogado }}</div>
            <div class="abogado-num">{{ item.cantidad }}</div>
            <div class="abogado-bar">
                <div class="abogado-bar-fill"
                     style="width: {{ (item.cantidad / por_abogado[0].cantidad * 100) | int }}%"></div>
            </div>
            <a href="/?abogado={{ item.abogado | urlencode }}" class="abogado-link">Ver ‚Üí</a>
        </div>
        {% endfor %}
    </div>
</div>

<!-- ‚îÄ‚îÄ PR√ìXIMOS A VENCER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
{% if proximos_lista %}
<div class="card" style="margin-top:16px">
    <h3 class="stat-card-title">‚ö†Ô∏è Pr√≥ximos a Vencer / Vencidos (60 d√≠as)</h3>
    <div class="table-wrapper" style="box-shadow:none; border:none">
        <table class="data-table">
            <thead>
                <tr>
                    <th>N¬∞ Exp.</th>
                    <th>A√±o</th>
                    <th>Investigado</th>
                    <th>Abogado</th>
                    <th>Etapa</th>
                    <th>Venc. Indagaci√≥n</th>
                    <th>Venc. Investigaci√≥n</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for exp in proximos_lista %}
                <tr>
                    <td class="exp-num"><strong>{{ exp.n_expediente }}</strong></td>
                    <td>{{ exp.anio }}</td>
                    <td class="td-texto">{{ exp.investigado or '‚Äî' }}</td>
                    <td class="td-texto">{{ exp.nombre_abogado or '‚Äî' }}</td>
                    <td><span class="etapa-badge">{{ exp.etapa or '‚Äî' }}</span></td>
                    <td>
                        {% if exp.fecha_vencimiento_ind %}
                        <span class="alerta-badge alerta-{{ exp.alerta_ind.clase }}">
                            {{ exp.fecha_vencimiento_ind }}<br>
                            <small>{{ exp.alerta_ind.texto }}</small>
                        </span>
                        {% else %}‚Äî{% endif %}
                    </td>
                    <td>
                        {% if exp.fecha_vencimiento_inv %}
                        <span class="alerta-badge alerta-{{ exp.alerta_inv.clase }}">
                            {{ exp.fecha_vencimiento_inv }}<br>
                            <small>{{ exp.alerta_inv.texto }}</small>
                        </span>
                        {% else %}‚Äî{% endif %}
                    </td>
                    <td>
                        <a href="/expediente/{{ exp.id }}" class="btn-sm btn-ver">üëÅ Ver</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- ‚îÄ‚îÄ EXPEDIENTES RECIENTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="card" style="margin-top:16px">
    <h3 class="stat-card-title">üïê √öltimos Registrados</h3>
    <div class="table-wrapper" style="box-shadow:none; border:none">
        <table class="data-table">
            <thead>
                <tr><th>N¬∞ Exp.</th><th>A√±o</th><th>Investigado</th><th>Abogado</th><th>Estado</th><th>Registrado</th><th></th></tr>
            </thead>
            <tbody>
                {% for exp in recientes %}
                <tr>
                    <td class="exp-num"><strong>{{ exp.n_expediente }}</strong></td>
                    <td>{{ exp.anio }}</td>
                    <td class="td-texto">{{ exp.investigado or '‚Äî' }}</td>
                    <td class="td-texto">{{ exp.nombre_abogado or '‚Äî' }}</td>
                    <td>{{ exp.estado_proceso or '‚Äî' }}</td>
                    <td style="font-size:11px; color:var(--text-muted)">{{ exp.created_at or '‚Äî' }}</td>
                    <td><a href="/expediente/{{ exp.id }}" class="btn-sm btn-ver">üëÅ Ver</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function abrirModal(tipo, cantidad, filtroParam) {
    var titulos = { vencidos:'Expedientes Vencidos', prox30:'Vencen en 30 d√≠as', prox60:'Vencen en 31‚Äì60 d√≠as' };
    document.getElementById('modal-titulo').textContent = titulos[tipo] || 'Exportar';
    document.getElementById('modal-desc').textContent = cantidad + ' expedientes con este filtro.';
    var base = '/exportar-filtrado/descargar?' + filtroParam;
    document.getElementById('btn-solo').href  = base;
    document.getElementById('btn-todos').href = base + '&incluir_todos=1';
    var alertaMap = { vencidos:'vencido', prox30:'proximo30', prox60:'proximo60' };
    document.getElementById('btn-ver').href   = '/?alerta=' + (alertaMap[tipo] || '');
    document.getElementById('modal-export').style.display = 'flex';
}
function cerrarModal() {
    document.getElementById('modal-export').style.display = 'none';
}
document.addEventListener('keydown', function(e){ if(e.key==='Escape') cerrarModal(); });
</script>

{% endblock %}
