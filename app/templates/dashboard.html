{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block heading %}Dashboard{% endblock %}

{% block header_actions %}
<a href="/expediente/nuevo" class="btn btn-primary">‚ûï Nuevo Expediente</a>
{% endblock %}

{% block content %}

<!-- ‚îÄ‚îÄ TARJETAS RESUMEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="dash-cards">
    <div class="dash-card dash-card-blue">
        <div class="dash-card-num">{{ total }}</div>
        <div class="dash-card-label">Total Expedientes</div>
        <a href="/" class="dash-card-link">Ver todos ‚Üí</a>
    </div>
    <div class="dash-card dash-card-danger">
        <div class="dash-card-num">{{ vencidos }}</div>
        <div class="dash-card-label">Vencidos</div>
        <a href="/?etapa=INDAGACI√ìN" class="dash-card-link">Ver ‚Üí</a>
    </div>
    <div class="dash-card dash-card-warning">
        <div class="dash-card-num">{{ prox30 }}</div>
        <div class="dash-card-label">Vencen en 30 d√≠as</div>
        <a href="/exportar-filtrado?proximos_30=1" class="dash-card-link">Exportar ‚Üí</a>
    </div>
    <div class="dash-card dash-card-info">
        <div class="dash-card-num">{{ prox60 }}</div>
        <div class="dash-card-label">Vencen en 31‚Äì60 d√≠as</div>
        <a href="/exportar-filtrado?proximos_60=1" class="dash-card-link">Exportar ‚Üí</a>
    </div>
</div>

<!-- ‚îÄ‚îÄ FILA DE ESTAD√çSTICAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="dash-stats-row">

    <!-- Por etapa -->
    <div class="dash-stat-card card">
        <h3 class="stat-card-title">Expedientes por Etapa</h3>
        {% for item in por_etapa %}
        <div class="bar-item">
            <span class="bar-label" title="{{ item.etapa }}">
                {{ item.etapa | truncate(30) }}
            </span>
            <div class="bar-track">
                <div class="bar-fill bar-blue"
                     style="width: {{ (item.cantidad / total * 100) | int }}%">
                </div>
            </div>
            <span class="bar-count">{{ item.cantidad }}</span>
        </div>
        {% endfor %}
    </div>

    <!-- Por estado -->
    <div class="dash-stat-card card">
        <h3 class="stat-card-title">Expedientes por Estado</h3>
        {% for item in por_estado %}
        <div class="bar-item">
            <span class="bar-label" title="{{ item.estado }}">
                {{ item.estado | truncate(28) }}
            </span>
            <div class="bar-track">
                <div class="bar-fill bar-green"
                     style="width: {{ (item.cantidad / total * 100) | int }}%">
                </div>
            </div>
            <span class="bar-count">{{ item.cantidad }}</span>
        </div>
        {% endfor %}
    </div>

    <!-- Por a√±o -->
    <div class="dash-stat-card card">
        <h3 class="stat-card-title">Expedientes por A√±o</h3>
        {% for item in por_anio %}
        <div class="bar-item">
            <span class="bar-label">{{ item.anio }}</span>
            <div class="bar-track">
                <div class="bar-fill bar-purple"
                     style="width: {{ (item.cantidad / total * 100) | int }}%">
                </div>
            </div>
            <span class="bar-count">{{ item.cantidad }}</span>
        </div>
        {% endfor %}
    </div>

</div>

<!-- ‚îÄ‚îÄ POR ABOGADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="dash-abogados card">
    <h3 class="stat-card-title">Carga por Abogado</h3>
    <div class="abogado-grid">
        {% for item in por_abogado %}
        <div class="abogado-card">
            <div class="abogado-name">{{ item.abogado }}</div>
            <div class="abogado-num">{{ item.cantidad }}</div>
            <div class="abogado-bar">
                <div class="abogado-bar-fill"
                     style="width: {{ (item.cantidad / por_abogado[0].cantidad * 100) | int }}%">
                </div>
            </div>
            <a href="/?abogado={{ item.abogado | urlencode }}" class="abogado-link">Ver ‚Üí</a>
        </div>
        {% endfor %}
    </div>
</div>

<!-- ‚îÄ‚îÄ PR√ìXIMOS A VENCER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
{% if proximos_lista %}
<div class="card" style="margin-top:16px">
    <h3 class="stat-card-title">‚ö†Ô∏è Pr√≥ximos a Vencer / Vencidos (60 d√≠as)</h3>
    <div class="table-wrapper" style="box-shadow:none; border:none">
        <table class="data-table">
            <thead>
                <tr>
                    <th>N¬∞ Exp.</th>
                    <th>A√±o</th>
                    <th>Investigado</th>
                    <th>Abogado</th>
                    <th>Etapa</th>
                    <th>Venc. Indagaci√≥n</th>
                    <th>Venc. Investigaci√≥n</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for exp in proximos_lista %}
                <tr>
                    <td class="exp-num"><strong>{{ exp.n_expediente }}</strong></td>
                    <td>{{ exp.anio }}</td>
                    <td class="td-texto">{{ exp.investigado or '‚Äî' }}</td>
                    <td class="td-texto">{{ exp.nombre_abogado or '‚Äî' }}</td>
                    <td><span class="etapa-badge">{{ exp.etapa or '‚Äî' }}</span></td>
                    <td>
                        {% if exp.fecha_vencimiento_ind %}
                        <span class="alerta-badge alerta-{{ exp.alerta_ind.clase }}">
                            {{ exp.fecha_vencimiento_ind }}<br>
                            <small>{{ exp.alerta_ind.texto }}</small>
                        </span>
                        {% else %}‚Äî{% endif %}
                    </td>
                    <td>
                        {% if exp.fecha_vencimiento_inv %}
                        <span class="alerta-badge alerta-{{ exp.alerta_inv.clase }}">
                            {{ exp.fecha_vencimiento_inv }}<br>
                            <small>{{ exp.alerta_inv.texto }}</small>
                        </span>
                        {% else %}‚Äî{% endif %}
                    </td>
                    <td>
                        <a href="/expediente/{{ exp.id }}" class="btn-sm btn-ver">üëÅ Ver</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- ‚îÄ‚îÄ EXPEDIENTES RECIENTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="card" style="margin-top:16px">
    <h3 class="stat-card-title">üïê √öltimos Registrados</h3>
    <div class="table-wrapper" style="box-shadow:none; border:none">
        <table class="data-table">
            <thead>
                <tr><th>N¬∞ Exp.</th><th>A√±o</th><th>Investigado</th><th>Abogado</th><th>Estado</th><th>Registrado</th><th></th></tr>
            </thead>
            <tbody>
                {% for exp in recientes %}
                <tr>
                    <td class="exp-num"><strong>{{ exp.n_expediente }}</strong></td>
                    <td>{{ exp.anio }}</td>
                    <td class="td-texto">{{ exp.investigado or '‚Äî' }}</td>
                    <td class="td-texto">{{ exp.nombre_abogado or '‚Äî' }}</td>
                    <td>{{ exp.estado_proceso or '‚Äî' }}</td>
                    <td style="font-size:11px; color:var(--text-muted)">{{ exp.created_at or '‚Äî' }}</td>
                    <td><a href="/expediente/{{ exp.id }}" class="btn-sm btn-ver">üëÅ Ver</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}
